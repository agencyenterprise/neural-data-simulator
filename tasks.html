<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasks &mdash; Neural Data Simulator 0.1.2 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Visualizing Data" href="visualization.html" />
    <link rel="prev" title="Decoders" href="decoders.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Neural Data Simulator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_bci.html">Quick Start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Neural Data Simulator</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="inputs.html">Behavioral Input</a></li>
<li class="toctree-l1"><a class="reference internal" href="encoder.html">Encoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="ephys_generator.html">Electrophysiology (Ephys) Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuring.html">Configuring NDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running NDS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extensions</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="extending.html">Extending NDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="decoders.html">Decoders</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tasks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#provided-task">Provided task</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-the-gui">Using the GUI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-without-a-decoder">Running without a decoder</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-your-own-task">Implementing your own task</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualizing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="utilities.html">Recording and Streaming</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="auto_examples/index.html">Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/agencyenterprise/neural-data-simulator/">GitHub Repository</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="nds/modules.html">Neural Data Simulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools/modules.html">Example Implementations and Utilities</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Neural Data Simulator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Tasks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tasks.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tasks">
<h1>Tasks<a class="headerlink" href="#tasks" title="Permalink to this heading"></a></h1>
<p>A tasks is a way to the user to interact with the system and it can be very general in the BCI context and in NDS.
Generally, it will present a user with a goal to achieve and give feedback on the user performance/results. In a speech decoding task, for example, it could show text prompts that it expects the user to speak and then present the result after the full NDS/BCI pipeline (i.e. all the steps to encode behavior data into neural data and back into behavior data).</p>
<p>In some approaches, the task will be responsible both for taking user input, converting it into behavior and also presenting the decoded behavior (i.e. the center-out reaching task example provided, that intercepts mouse movement, calculates velocity, sends it into the BCI loop, and presents the decoded behavior instead of the user original input); in others, this can be split into more applications (for example a speech decoding task, where microphone signal could be captured by one application and sent to the BCI loop as input behavior data, where a separate task prompts the user with the expected text to read and presents the decoded text).</p>
<section id="provided-task">
<h2>Provided task<a class="headerlink" href="#provided-task" title="Permalink to this heading"></a></h2>
<p>The task provided with NDS is a center-out reaching task. This is a modified implementation of the task described in the paper <a class="reference external" href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1006808">Structure and variability of delay activity in premotor cortex</a> by Even-Chen et al.</p>
<p>In this task, the participant is instructed to reach from a starting position towards a target, which is located either on the center of the screen or on a radial pattern from the center. They must move to the target and stay within the target for a short period. Outer and center targets alternate until the participant decides to stop. The number of outer target locations is fixed and their order of appearance is randomized.</p>
<p>The <a class="reference external" href="https://www.pygame.org/"><code class="docutils literal notranslate"><span class="pre">pygame</span></code></a> application takes input through LSL of the decoded behavior data (which represents cursor velocity) that updates the main cursor position used  to reach targets and complete the task. The application also output the behavior data through LSL, which is obtained by intercepting cursor velocity when the user moves the mouse attempting to reach the target. The display of the real input cursor position can be toggled on or off by the user, but it cannot be used to complete the task of reaching the targets.</p>
<section id="using-the-gui">
<h3>Using the GUI<a class="headerlink" href="#using-the-gui" title="Permalink to this heading"></a></h3>
<p>As described above, the GUI keeps track of 2 cursors: the real cursor that is controlled by the user, and the decoded cursor that is controlled by the output of the decoder. The decoded cursor velocity is read from an LSL stream. If the stream cannot be found, the GUI will not be able to start, therefore make sure that a decoder is running before starting the GUI.</p>
<p>To start the GUI, complete the <a class="reference internal" href="installation.html"><span class="std std-doc">installation</span></a>, then run the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">center_out_reach</span>
</pre></div>
</div>
<p>To customize the GUI, change the configuration file <code class="docutils literal notranslate"><span class="pre">settings_center_out_reach.yaml</span></code>, which is located by default in the <code class="docutils literal notranslate"><span class="pre">$HOME/.nds/</span></code> folder. You can point the script to use a different configuration file by passing the <code class="docutils literal notranslate"><span class="pre">--settings-path</span></code> argument.</p>
<p>The GUI responds to the following key presses:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">c</span></code> will hide the mouse cursor and leave only the decoded cursor visible.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">k</span></code> will start a fresh recording of data used to show the velocities and trajectories plots after the task is finished.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">space</span></code> will reset the position of both cursors to the center of the screen.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">esc</span></code> closes the GUI.</p></li>
</ol>
<p>By default, the GUI is configured to collect metrics of the task. When the user presses <code class="docutils literal notranslate"><span class="pre">esc</span></code> to close the GUI the following screen is displayed:</p>
<p><img alt="gui-r2" src="_images/gui-r2.png" /></p>
<p>The image above shows the coefficient of determination (<span class="math notranslate nohighlight">\(r^2\)</span>) between the user input values and the decoded values, for the vertical and horizontal directions.</p>
<p>When the user closes the above screen, the cursor trajectories are displayed:</p>
<p><img alt="gui-trajectories" src="_images/gui-trajectories.png" /></p>
<p>The dashed lines represent the user input trajectories, whereas the unbroken lines represent the decoded trajectories.</p>
</section>
<section id="running-without-a-decoder">
<h3>Running without a decoder<a class="headerlink" href="#running-without-a-decoder" title="Permalink to this heading"></a></h3>
<p>If you want to run the center-out reach task in open loop (without the cursor velocities from the decoder), change the following configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">center_out_reach</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
</pre></div>
</div>
</section>
</section>
<section id="implementing-your-own-task">
<h2>Implementing your own task<a class="headerlink" href="#implementing-your-own-task" title="Permalink to this heading"></a></h2>
<p>Following is a simple implementation of a task, implemented as a python script that sends data to the NDS encoder and reads the data from the decoder.
To keep it simple, the behavior data is randomly generated.
However, this demonstrates the framework required for creating your own BCI task.
See below for a complete example of a center-out task.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pylsl</span>


<span class="k">def</span> <span class="nf">get_lsl_outlet</span><span class="p">():</span>
    <span class="n">stream_info</span> <span class="o">=</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">StreamInfo</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;NDS-Behavior&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;behavior&quot;</span><span class="p">,</span>
        <span class="n">channel_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">nominal_srate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">channel_format</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
        <span class="n">source_id</span><span class="o">=</span><span class="s2">&quot;centerout_behavior&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">channels_info</span> <span class="o">=</span> <span class="n">stream_info</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="s2">&quot;channels&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ch_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vel_x&quot;</span><span class="p">,</span> <span class="s2">&quot;vel_y&quot;</span><span class="p">]:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">channels_info</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">append_child_value</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">ch_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">StreamOutlet</span><span class="p">(</span><span class="n">stream_info</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_lsl_inlet</span><span class="p">():</span>
    <span class="n">stream_infos</span> <span class="o">=</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">resolve_byprop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;NDS-Decoder&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_infos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">StreamInlet</span><span class="p">(</span><span class="n">stream_infos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Inlet could not find requested LSL stream.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">loop_interval</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mf">1e6</span>  <span class="c1"># nanoseconds</span>

    <span class="n">lsl_outlet</span> <span class="o">=</span> <span class="n">get_lsl_outlet</span><span class="p">()</span>
    <span class="n">lsl_inlet</span> <span class="o">=</span> <span class="n">get_lsl_inlet</span><span class="p">()</span>
    <span class="n">last_run_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter_ns</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">time_now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter_ns</span><span class="p">()</span>
        <span class="n">elapsed_time_ns</span> <span class="o">=</span> <span class="n">time_now</span> <span class="o">-</span> <span class="n">last_run_time</span>
        <span class="k">if</span> <span class="n">elapsed_time_ns</span> <span class="o">&gt;=</span> <span class="n">loop_interval</span><span class="p">:</span>
            <span class="n">samples</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lsl_inlet</span><span class="o">.</span><span class="n">pull_chunk</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Decoded: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">behavior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span> <span class="o">*</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Behavior: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
                <span class="n">lsl_outlet</span><span class="o">.</span><span class="n">push_sample</span><span class="p">(</span><span class="n">behavior</span><span class="p">)</span>
            <span class="n">last_run_time</span> <span class="o">=</span> <span class="n">time_now</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When integrating this script into the loop, ensure that the default GUI is not running in order to prevent an LSL outlet name conflict. To achieve this change the <code class="docutils literal notranslate"><span class="pre">run-closed-loop</span></code> Makefile target removing the <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">run</span> <span class="pre">center_out_reach</span></code> command.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="decoders.html" class="btn btn-neutral float-left" title="Decoders" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="visualization.html" class="btn btn-neutral float-right" title="Visualizing Data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, AE Studio &amp; Chadwick Boulay.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>